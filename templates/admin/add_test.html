{% extends "base.html" %}

{% block title %}Adaugă Test - Just Learn It History{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form method="POST" action="{{ url_for('add_test') }}">
                        {{ form.csrf_token }}
                        
                        <div class="mb-4">
                            {{ form.title(class="form-control form-control-lg border-0 fw-bold", placeholder="Titlul testului", style="font-size: 1.5rem;") }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.title.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.order(class="form-control", type="number", min="1", placeholder="Ordinea testului") }}
                            {% if form.order.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.order.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        {{ form.questions_json(id="questions_json", style="display: none;") }}
                    </form>
                </div>
            </div>

            <div id="questions-container">
                <!-- Questions will be added here dynamically -->
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4">
                <button type="button" class="btn btn-primary" onclick="addQuestion()">
                    <i class="fas fa-plus me-2"></i>Adaugă Întrebare
                </button>
                <button type="submit" class="btn btn-success" onclick="submitForm()">
                    <i class="fas fa-save me-2"></i>Salvează Testul
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
let questions = [];
let questionEditors = {};

function addQuestion(existingQuestion = null) {
    const questionIndex = questions.length;
    const question = existingQuestion || {
        type: 'multiple_choice',
        text: '',
        options: ['', ''],
        correct_answer: ''
    };
    
    const card = document.createElement('div');
    card.className = 'card shadow-sm mb-3 question-card';
    card.id = `question-${questionIndex}`;
    
    const cardHtml = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary me-2">Q${questionIndex + 1}</span>
                    <select class="form-select" onchange="updateQuestionType(${questionIndex}, this.value)">
                        <option value="multiple_choice" ${question.type === 'multiple_choice' ? 'selected' : ''}>Alegere Multiplă</option>
                        <option value="true_false" ${question.type === 'true_false' ? 'selected' : ''}>Adevărat/Fals</option>
                        <option value="short_answer" ${question.type === 'short_answer' ? 'selected' : ''}>Răspuns Scurt</option>
                    </select>
                </div>
                <div class="question-actions">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteQuestion(${questionIndex})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="mb-4">
                <div id="question-editor-${questionIndex}" class="form-control question-editor"></div>
            </div>
            
            <div id="options-${questionIndex}" class="options-container mb-4">
                <!-- Options will be added here -->
            </div>
            
            <div class="correct-answer-container">
                <label class="form-label fw-bold">
                    <i class="fas fa-check-circle text-success me-2"></i>Răspuns Corect
                </label>
                <div id="correct-answer-${questionIndex}"></div>
            </div>
        </div>
    `;
    
    card.innerHTML = cardHtml;
    document.getElementById('questions-container').appendChild(card);
    
    // Initialize Quill editor for the question
    const quill = new Quill(`#question-editor-${questionIndex}`, {
        theme: 'snow',
        modules: {
            toolbar: {
                container: [
                    ['bold', 'italic', 'underline'],
                    ['link', 'image'],
                    ['clean']
                ],
                handlers: {
                    'image': function() {
                        var input = document.createElement('input');
                        input.setAttribute('type', 'file');
                        input.setAttribute('accept', 'image/*');
                        input.click();
                        
                        input.onchange = function() {
                            var file = input.files[0];
                            if (file) {
                                var formData = new FormData();
                                formData.append('image', file);
                                
                                fetch('/upload-image', {
                                    method: 'POST',
                                    body: formData,
                                    credentials: 'same-origin'
                                })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.url) {
                                        var range = quill.getSelection();
                                        quill.insertEmbed(range.index, 'image', data.url);
                                    } else {
                                        console.error('Upload failed:', data.error);
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                });
                            }
                        };
                    }
                }
            }
        }
    });
    
    // Set initial content if editing existing question
    if (existingQuestion) {
        quill.root.innerHTML = question.text;
    }
    
    // Store the Quill instance
    questionEditors[questionIndex] = quill;
    
    // Add question to the array if it's new
    if (!existingQuestion) {
        questions.push(question);
    }
    
    // Update the hidden input
    updateQuestionsJson();
    
    // Add options for multiple choice
    updateQuestionType(questionIndex, question.type);
}

function updateQuestionType(index, type) {
    questions[index].type = type;
    const optionsContainer = document.getElementById(`options-${index}`);
    optionsContainer.innerHTML = '';
    
    if (type === 'multiple_choice') {
        if (!questions[index].options || questions[index].options.length === 0) {
            questions[index].options = ['', ''];
        }
        
        questions[index].options.forEach((option, i) => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'input-group mb-2';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.value = option;
            input.onchange = (e) => {
                questions[index].options[i] = e.target.value;
                updateQuestionsJson();
            };
            
            const correctInput = document.createElement('input');
            correctInput.type = 'radio';
            correctInput.name = `correct-${index}`;
            correctInput.checked = questions[index].correct_answer === option;
            correctInput.onchange = () => {
                questions[index].correct_answer = option;
                updateQuestionsJson();
            };
            
            optionDiv.appendChild(correctInput);
            optionDiv.appendChild(input);
            optionsContainer.appendChild(optionDiv);
        });
    }
    updateQuestionsJson();
}

function updateQuestionsJson() {
    // Update question texts from editors
    Object.entries(questionEditors).forEach(([index, editor]) => {
        if (questions[index]) {
            questions[index].text = editor.root.innerHTML;
        }
    });
    
    document.getElementById('questions_json').value = JSON.stringify(questions);
}

function deleteQuestion(index) {
    document.getElementById(`question-${index}`).remove();
    questions.splice(index, 1);
    delete questionEditors[index];
    
    // Rerender all questions to update indices
    document.getElementById('questions-container').innerHTML = '';
    questions.forEach((q, i) => addQuestion(q));
    updateQuestionsJson();
}

function submitForm() {
    updateQuestionsJson();
    if (questions.length === 0) {
        alert('Adăugați cel puțin o întrebare!');
        return;
    }
    document.querySelector('form').submit();
}

// Initialize with one question
addQuestion();
</script>
{% endblock %}

{% block styles %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .question-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .question-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1) !important;
    }
    
    .question-editor {
        height: 150px;
        margin-bottom: 1rem;
    }
    
    .ql-container {
        font-size: 16px !important;
    }
    
    .ql-editor {
        padding: 12px 15px !important;
    }
    
    .ql-toolbar {
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
    }
    
    .ql-container {
        border-bottom-left-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }
    
    .options-container {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.375rem;
    }
    
    .input-group-text {
        min-width: 45px;
    }
    
    .form-select {
        max-width: 200px;
    }
    
    .badge {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }

    .true-false-options {
        padding: 0.5rem 1rem;
    }

    .true-false-options .form-check {
        padding: 0.75rem 1.75rem;
        border-radius: 0.375rem;
        transition: background-color 0.2s ease;
    }

    .true-false-options .form-check:hover {
        background-color: #e9ecef;
    }

    .true-false-options .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .true-false-options .form-check-label {
        font-weight: 500;
        cursor: pointer;
    }
</style>
{% endblock %} 