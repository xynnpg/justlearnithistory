{% extends "base.html" %}

{% block title %}Adaugă Test - Just Learn It History{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm mb-4">
                <div class="card-body">
                    <form method="POST">
                        {{ form.csrf_token }}
                        
                        <div class="mb-4">
                            {{ form.title(class="form-control form-control-lg border-0 fw-bold", placeholder="Titlul testului", style="font-size: 1.5rem;") }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.title.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        <div class="mb-3">
                            {{ form.order(class="form-control", type="number", min="1", placeholder="Ordinea testului") }}
                            {% if form.order.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.order.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>

                        {{ form.questions_json(id="questions_json", style="display: none;") }}
                    </form>
                </div>
            </div>

            <div id="questions-container">
                <!-- Questions will be added here dynamically -->
            </div>

            <div class="d-flex justify-content-between align-items-center mt-4">
                <button type="button" class="btn btn-primary" onclick="addQuestion()">
                    <i class="fas fa-plus me-2"></i>Adaugă Întrebare
                </button>
                <button type="submit" class="btn btn-success" onclick="submitForm()">
                    <i class="fas fa-save me-2"></i>Salvează Testul
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
let questions = [];
let questionEditors = {};

function addQuestion(existingQuestion = null) {
    const questionIndex = questions.length;
    const question = existingQuestion || {
        type: 'multiple_choice',
        text: '',
        options: ['', ''],
        correct_answer: ''
    };
    
    const card = document.createElement('div');
    card.className = 'card shadow-sm mb-3 question-card';
    card.id = `question-${questionIndex}`;
    
    const cardHtml = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div class="d-flex align-items-center">
                    <span class="badge bg-primary me-2">Q${questionIndex + 1}</span>
                    <select class="form-select" onchange="updateQuestionType(${questionIndex}, this.value)">
                        <option value="multiple_choice" ${question.type === 'multiple_choice' ? 'selected' : ''}>Alegere Multiplă</option>
                        <option value="true_false" ${question.type === 'true_false' ? 'selected' : ''}>Adevărat/Fals</option>
                        <option value="short_answer" ${question.type === 'short_answer' ? 'selected' : ''}>Răspuns Scurt</option>
                    </select>
                </div>
                <div class="question-actions">
                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="deleteQuestion(${questionIndex})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="mb-4">
                <div id="question-editor-${questionIndex}" class="form-control question-editor"></div>
            </div>
            
            <div id="options-${questionIndex}" class="options-container mb-4">
                <!-- Options will be added here -->
            </div>
            
            <div class="correct-answer-container">
                <label class="form-label fw-bold">
                    <i class="fas fa-check-circle text-success me-2"></i>Răspuns Corect
                </label>
                <input type="text" class="form-control" 
                       value="${question.correct_answer || ''}" 
                       onchange="updateCorrectAnswer(${questionIndex}, this.value)"
                       placeholder="Introduceți răspunsul corect">
            </div>
        </div>
    `;
    
    card.innerHTML = cardHtml;
    document.getElementById('questions-container').appendChild(card);
    
    // Initialize Quill
    const quill = new Quill(`#question-editor-${questionIndex}`, {
        theme: 'snow',
        placeholder: 'Introduceți textul întrebării...',
        modules: {
            toolbar: [
                ['bold', 'italic', 'underline'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link', 'image'],
                ['clean']
            ]
        }
    });
    
    if (question.text) {
        quill.root.innerHTML = question.text;
    }
    
    questionEditors[questionIndex] = quill;
    
    if (!existingQuestion) {
        questions.push(question);
    }
    
    updateQuestionType(questionIndex, question.type);
    updateQuestionsJson();
}

function updateQuestionType(index, type) {
    questions[index].type = type;
    const optionsContainer = document.getElementById(`options-${index}`);
    optionsContainer.innerHTML = '';
    
    if (type === 'multiple_choice') {
        if (!questions[index].options || questions[index].options.length < 2) {
            questions[index].options = ['', ''];
        }
        
        const optionsHtml = `
            <label class="form-label fw-bold mb-3">
                <i class="fas fa-list-ul text-primary me-2"></i>Opțiuni
            </label>
            <div class="options-list"></div>
            <button type="button" class="btn btn-outline-primary btn-sm mt-3" onclick="addOption(${index})">
                <i class="fas fa-plus me-2"></i>Adaugă Opțiune
            </button>
        `;
        
        optionsContainer.innerHTML = optionsHtml;
        
        questions[index].options.forEach((option, optionIndex) => {
            addOptionInput(index, option, optionIndex);
        });

        // Show correct answer input
        document.querySelector(`#question-${index} .correct-answer-container`).style.display = 'block';
    } else if (type === 'true_false') {
        // For true/false questions, create radio buttons
        const optionsHtml = `
            <label class="form-label fw-bold mb-3">
                <i class="fas fa-toggle-on text-primary me-2"></i>Opțiuni
            </label>
            <div class="true-false-options">
                <div class="form-check mb-2">
                    <input class="form-check-input" type="radio" name="correct-${index}" id="true-${index}" 
                           value="adevarat" onchange="updateTrueFalseAnswer(${index}, 'adevarat')"
                           ${questions[index].correct_answer === 'adevarat' ? 'checked' : ''}>
                    <label class="form-check-label" for="true-${index}">
                        Adevărat
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="radio" name="correct-${index}" id="false-${index}" 
                           value="fals" onchange="updateTrueFalseAnswer(${index}, 'fals')"
                           ${questions[index].correct_answer === 'fals' ? 'checked' : ''}>
                    <label class="form-check-label" for="false-${index}">
                        Fals
                    </label>
                </div>
            </div>
        `;
        
        optionsContainer.innerHTML = optionsHtml;
        
        // Hide the correct answer input for true/false questions
        document.querySelector(`#question-${index} .correct-answer-container`).style.display = 'none';
    } else {
        // For short answer questions
        // Show correct answer input
        document.querySelector(`#question-${index} .correct-answer-container`).style.display = 'block';
    }
    
    updateQuestionsJson();
}

function addOption(questionIndex) {
    questions[questionIndex].options.push('');
    addOptionInput(questionIndex, '', questions[questionIndex].options.length - 1);
    updateQuestionsJson();
}

function addOptionInput(questionIndex, value, optionIndex) {
    const optionsList = document.querySelector(`#options-${questionIndex} .options-list`);
    const optionDiv = document.createElement('div');
    optionDiv.className = 'input-group mb-2';
    
    const optionHtml = `
        <span class="input-group-text bg-light">
            <i class="fas fa-circle-dot text-primary"></i>
        </span>
        <input type="text" class="form-control" 
               placeholder="Opțiunea ${optionIndex + 1}"
               value="${value}"
               onchange="updateOption(${questionIndex}, ${optionIndex}, this.value)">
        <button type="button" class="btn btn-outline-danger" onclick="removeOption(${questionIndex}, ${optionIndex})">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    optionDiv.innerHTML = optionHtml;
    optionsList.appendChild(optionDiv);
}

function updateOption(questionIndex, optionIndex, value) {
    questions[questionIndex].options[optionIndex] = value;
    updateQuestionsJson();
}

function removeOption(questionIndex, optionIndex) {
    if (questions[questionIndex].options.length > 2) {
        questions[questionIndex].options.splice(optionIndex, 1);
        updateQuestionType(questionIndex, 'multiple_choice');
    } else {
        alert('Trebuie să existe cel puțin două opțiuni!');
    }
}

function deleteQuestion(index) {
    document.getElementById(`question-${index}`).remove();
    questions.splice(index, 1);
    delete questionEditors[index];
    
    // Rerender all questions to update indices
    document.getElementById('questions-container').innerHTML = '';
    questions.forEach((q, i) => addQuestion(q));
    updateQuestionsJson();
}

function updateCorrectAnswer(index, value) {
    questions[index].correct_answer = value;
    updateQuestionsJson();
}

function updateTrueFalseAnswer(index, value) {
    questions[index].correct_answer = value;
    updateQuestionsJson();
}

function updateQuestionsJson() {
    // Update question texts from editors
    Object.entries(questionEditors).forEach(([index, editor]) => {
        if (questions[index]) {
            questions[index].text = editor.root.innerHTML;
        }
    });
    
    document.getElementById('questions_json').value = JSON.stringify(questions);
}

function submitForm() {
    updateQuestionsJson();
    if (questions.length === 0) {
        alert('Adăugați cel puțin o întrebare!');
        return;
    }
    document.querySelector('form').submit();
}

// Initialize with one question
document.addEventListener('DOMContentLoaded', function() {
    addQuestion();
});
</script>
{% endblock %}

{% block styles %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .question-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .question-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1) !important;
    }
    
    .question-editor {
        height: 150px;
        margin-bottom: 1rem;
    }
    
    .ql-container {
        font-size: 16px !important;
    }
    
    .ql-editor {
        padding: 12px 15px !important;
    }
    
    .ql-toolbar {
        border-top-left-radius: 0.375rem;
        border-top-right-radius: 0.375rem;
    }
    
    .ql-container {
        border-bottom-left-radius: 0.375rem;
        border-bottom-right-radius: 0.375rem;
    }
    
    .options-container {
        background-color: #f8f9fa;
        padding: 1rem;
        border-radius: 0.375rem;
    }
    
    .input-group-text {
        min-width: 45px;
    }
    
    .form-select {
        max-width: 200px;
    }
    
    .badge {
        font-size: 1rem;
        padding: 0.5rem 1rem;
    }

    .true-false-options {
        padding: 0.5rem 1rem;
    }

    .true-false-options .form-check {
        padding: 0.75rem 1.75rem;
        border-radius: 0.375rem;
        transition: background-color 0.2s ease;
    }

    .true-false-options .form-check:hover {
        background-color: #e9ecef;
    }

    .true-false-options .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .true-false-options .form-check-label {
        font-weight: 500;
        cursor: pointer;
    }
</style>
{% endblock %} 