{% extends "base.html" %}

{% block title %}Teste - Just Learn It History{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="display-4 mb-3">Teste</h1>
            <p class="lead text-muted">Verifică-ți cunoștințele cu aceste teste interactive</p>
        </div>
    </div>

    <div class="row">
        {% for test in tests %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card test-card h-100">
                <div class="card-body">
                    <h5 class="card-title">{{ test.title }}</h5>
                    <p class="card-text">Completează acest test pentru a-ți verifica cunoștințele.</p>
                    <button class="btn btn-primary" onclick="startTest({{ test.id }})">
                        <i class="fas fa-play me-2"></i>Începe Testul
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="testModal" tabindex="-1" aria-labelledby="testModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testModalLabel">Test</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="test-container">
                    <div id="test-questions"></div>
                    <div class="d-flex justify-content-between mt-4">
                        <button type="button" class="btn btn-secondary" id="prev-question" disabled>
                            <i class="fas fa-arrow-left me-2"></i>Întrebarea Anterioară
                        </button>
                        <button type="button" class="btn btn-primary" id="next-question">
                            Următoarea Întrebare<i class="fas fa-arrow-right ms-2"></i>
                        </button>
                    </div>
                </div>
                <div id="test-results" class="d-none">
                    <div class="text-center mb-4">
                        <h3>Rezultatele Testului</h3>
                        <div class="display-4 text-primary my-4" id="test-score">0%</div>
                        <p id="test-summary">Ai răspuns corect la 0 din 0 întrebări.</p>
                    </div>
                    <div class="d-grid">
                        <button type="button" class="btn btn-primary" onclick="closeTest()">
                            <i class="fas fa-check me-2"></i>Închide
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
<script>
    let currentTest = null;
    let currentQuestions = [];
    let currentQuestionIndex = 0;
    let userAnswers = [];
    let quill = null;
    
    function startTest(testId) {
        // Reset state
        currentQuestionIndex = 0;
        userAnswers = [];
        
        // Fetch test data
        fetch(`/test/${testId}`)
            .then(response => response.json())
            .then(data => {
                currentTest = data;
                currentQuestions = JSON.parse(data.questions);
                
                // Show test modal
                const modal = new bootstrap.Modal(document.getElementById('testModal'));
                modal.show();
                
                // Update modal title
                document.getElementById('testModalLabel').textContent = data.title;
                
                // Show first question
                showQuestion(0);
            })
            .catch(error => {
                console.error('Error fetching test:', error);
                alert('A apărut o eroare la încărcarea testului. Te rugăm să încerci din nou.');
            });
    }
    
    function showQuestion(index) {
        const question = currentQuestions[index];
        const container = document.getElementById('test-questions');
        
        // Clear previous content
        container.innerHTML = '';
        
        // Create question display
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-container mb-4';
        
        // Add question number
        const questionNumber = document.createElement('div');
        questionNumber.className = 'question-number mb-2';
        questionNumber.textContent = `Întrebarea ${index + 1} din ${currentQuestions.length}`;
        questionDiv.appendChild(questionNumber);
        
        // Add question text using Quill
        const questionText = document.createElement('div');
        questionText.className = 'question-text mb-4';
        questionDiv.appendChild(questionText);
        
        // Initialize Quill for question text
        if (quill) {
            quill.container.remove();
        }
        quill = new Quill(questionText, {
            theme: 'snow',
            readOnly: true,
            modules: {
                toolbar: false
            }
        });
        quill.root.innerHTML = question.text;
        
        // Add answer options based on question type
        const answerContainer = document.createElement('div');
        answerContainer.className = 'answer-container mt-4';
        
        if (question.type === 'multiple_choice') {
            question.options.forEach((option, optionIndex) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'form-check mb-2';
                
                const input = document.createElement('input');
                input.type = 'radio';
                input.className = 'form-check-input';
                input.name = `question-${index}`;
                input.id = `option-${optionIndex}`;
                input.value = option;
                input.checked = userAnswers[index] === option;
                input.onchange = () => {
                    userAnswers[index] = option;
                };
                
                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = `option-${optionIndex}`;
                label.textContent = option;
                
                optionDiv.appendChild(input);
                optionDiv.appendChild(label);
                answerContainer.appendChild(optionDiv);
            });
        } else if (question.type === 'true_false') {
            const optionsContainer = document.createElement('div');
            optionsContainer.className = 'true-false-options';
            
            ['Adevărat', 'Fals'].forEach((option, optionIndex) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'form-check mb-2';
                
                const input = document.createElement('input');
                input.type = 'radio';
                input.className = 'form-check-input';
                input.name = `question-${index}`;
                input.id = `option-${index}-${optionIndex}`;
                input.value = option.toLowerCase();
                input.checked = userAnswers[index] === option.toLowerCase();
                input.onchange = () => {
                    userAnswers[index] = option.toLowerCase();
                };
                
                const label = document.createElement('label');
                label.className = 'form-check-label';
                label.htmlFor = `option-${index}-${optionIndex}`;
                label.textContent = option;
                
                optionDiv.appendChild(input);
                optionDiv.appendChild(label);
                optionsContainer.appendChild(optionDiv);
            });
            
            answerContainer.appendChild(optionsContainer);
        } else {  // short answer
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'form-control';
            input.placeholder = 'Scrie răspunsul tău aici...';
            input.value = userAnswers[index] || '';
            input.onchange = (e) => {
                userAnswers[index] = e.target.value;
            };
            answerContainer.appendChild(input);
        }
        
        questionDiv.appendChild(answerContainer);
        container.appendChild(questionDiv);
        
        // Update navigation buttons
        document.getElementById('prev-question').disabled = index === 0;
        document.getElementById('next-question').textContent = 
            index === currentQuestions.length - 1 ? 'Finalizează Testul' : 'Următoarea Întrebare';
        document.getElementById('next-question').innerHTML = 
            index === currentQuestions.length - 1 ? 
            '<i class="fas fa-check me-2"></i>Finalizează Testul' : 
            'Următoarea Întrebare<i class="fas fa-arrow-right ms-2"></i>';
        
        // Show test container, hide results
        document.getElementById('test-container').classList.remove('d-none');
        document.getElementById('test-results').classList.add('d-none');
    }
    
    function submitTest() {
        // Send answers to server
        fetch(`/submit_test/${currentTest.id}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                answers: userAnswers.map((answer, index) => ({
                    questionIndex: index,
                    answer: answer
                }))
            })
        })
        .then(response => response.json())
        .then(data => {
            // Show results
            document.getElementById('test-container').classList.add('d-none');
            document.getElementById('test-results').classList.remove('d-none');
            
            // Update score display
            const scoreElement = document.getElementById('test-score');
            scoreElement.textContent = `${Math.round(data.score)}%`;
            
            // Update score color based on percentage
            if (data.score >= 90) {
                scoreElement.classList.remove('text-primary', 'text-warning', 'text-danger');
                scoreElement.classList.add('text-success');
            } else if (data.score >= 70) {
                scoreElement.classList.remove('text-primary', 'text-success', 'text-danger');
                scoreElement.classList.add('text-warning');
            } else {
                scoreElement.classList.remove('text-primary', 'text-success', 'text-warning');
                scoreElement.classList.add('text-danger');
            }
            
            document.getElementById('test-summary').textContent = 
                `Ai răspuns corect la ${data.correct_answers} din ${data.total_questions} întrebări.`;
        })
        .catch(error => {
            console.error('Error submitting test:', error);
            alert('A apărut o eroare la trimiterea testului. Te rugăm să încerci din nou.');
        });
    }
    
    function closeTest() {
        const modal = bootstrap.Modal.getInstance(document.getElementById('testModal'));
        modal.hide();
        
        // Clean up
        if (quill) {
            quill.container.remove();
            quill = null;
        }
    }
    
    // Set up event listeners
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('prev-question').addEventListener('click', function() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                showQuestion(currentQuestionIndex);
            }
        });
        
        document.getElementById('next-question').addEventListener('click', function() {
            if (currentQuestionIndex < currentQuestions.length - 1) {
                currentQuestionIndex++;
                showQuestion(currentQuestionIndex);
            } else {
                submitTest();
            }
        });
    });
</script>
{% endblock %}

{% block styles %}
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<style>
    .test-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .test-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .question-number {
        font-weight: bold;
        color: var(--primary-color);
    }
    
    .question-text {
        margin-bottom: 1.5rem;
    }
    
    .ql-editor {
        padding: 0;
    }
    
    .ql-container.ql-snow {
        border: none;
    }
    
    .form-check {
        margin-bottom: 1rem;
    }
    
    .form-check-input:checked {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }
    
    .answer-container {
        padding: 1rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
    }

    .true-false-options {
        display: flex;
        gap: 2rem;
        justify-content: center;
        padding: 1rem 0;
    }

    .true-false-options .form-check {
        padding: 1rem 2rem;
        border-radius: 0.5rem;
        background-color: white;
        border: 1px solid #dee2e6;
        transition: all 0.2s ease;
        margin: 0;
        min-width: 150px;
        text-align: center;
    }

    .true-false-options .form-check:hover {
        background-color: #e9ecef;
        transform: translateY(-2px);
    }

    .true-false-options .form-check-input {
        margin-right: 0.75rem;
    }

    .true-false-options .form-check-label {
        font-weight: 500;
        cursor: pointer;
    }

    .true-false-options .form-check-input:checked ~ .form-check-label {
        color: var(--primary-color);
    }
</style>
{% endblock %} 